<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CDA Batch Package Generator</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Source+Sans+3:wght@300;400;600&display=swap');

  :root {
    --navy:   #1a2744;
    --gold:   #c49a2a;
    --gold-l: #e8c766;
    --cream:  #faf8f3;
    --mid:    #6b7a99;
    --ok:     #2d7a4f;
    --warn:   #b85c1a;
    --border: #d4cdb8;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Source Sans 3', sans-serif; background: var(--cream); color: var(--navy); min-height: 100vh; }

  header {
    background: var(--navy);
    padding: 24px 48px;
    display: flex;
    align-items: center;
    gap: 18px;
    border-bottom: 3px solid var(--gold);
  }
  header .badge { width: 44px; height: 44px; border-radius: 50%; background: var(--gold); display: flex; align-items: center; justify-content: center; font-size: 20px; }
  header h1 { font-family: 'Playfair Display', serif; font-size: 1.35rem; color: #fff; }
  header p { color: var(--gold-l); font-size: 0.75rem; font-weight: 300; letter-spacing: 0.08em; text-transform: uppercase; }

  main { max-width: 980px; margin: 0 auto; padding: 44px 24px; }

  #dropzone {
    border: 2px dashed var(--border);
    border-radius: 12px;
    background: #fff;
    padding: 52px 40px;
    text-align: center;
    cursor: pointer;
    transition: border-color .2s, background .2s;
    position: relative;
  }
  #dropzone:hover, #dropzone.dragover { border-color: var(--gold); background: #fffcf3; }
  #dropzone input[type=file] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
  #dropzone .drop-icon { font-size: 38px; margin-bottom: 10px; }
  #dropzone h2 { font-family: 'Playfair Display', serif; font-size: 1.2rem; margin-bottom: 6px; }
  #dropzone p { color: var(--mid); font-size: 0.88rem; }

  #summary { display: none; margin-top: 28px; background: #fff; border-radius: 12px; border: 1px solid var(--border); overflow: hidden; }
  .sum-head { background: var(--navy); color: #fff; padding: 18px 26px; display: flex; justify-content: space-between; align-items: center; }
  .sum-head h3 { font-family: 'Playfair Display', serif; font-size: 1rem; }
  .sum-head span { font-size: 0.78rem; opacity: .65; }

  .stat-row { display: grid; grid-template-columns: repeat(4,1fr); border-bottom: 1px solid var(--border); }
  .stat-box { padding: 18px 20px; border-right: 1px solid var(--border); text-align: center; }
  .stat-box:last-child { border-right: none; }
  .stat-num { font-family: 'Playfair Display', serif; font-size: 1.9rem; color: var(--navy); }
  .stat-lbl { font-size: 0.7rem; color: var(--mid); text-transform: uppercase; letter-spacing: .07em; margin-top: 2px; }

  .tbl-wrap { overflow-x: auto; max-height: 340px; overflow-y: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 0.855rem; }
  thead th {
    background: #f3f1eb;
    padding: 9px 14px;
    text-align: left;
    font-weight: 600;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: .06em;
    color: var(--mid);
    position: sticky; top: 0;
    border-bottom: 1px solid var(--border);
  }
  tbody tr { border-bottom: 1px solid #f0ede4; }
  tbody tr:hover { background: #faf8f2; }
  tbody td { padding: 9px 14px; }

  .b-dual { display: inline-block; background: #e8f4ed; color: var(--ok); border-radius: 4px; font-size: .68rem; padding: 2px 6px; font-weight: 600; }
  .b-path { display: inline-block; background: #eef0f8; color: var(--navy); border-radius: 4px; font-size: .68rem; padding: 2px 6px; margin: 1px; }
  .b-count { display: inline-block; background: var(--navy); color: var(--gold-l); border-radius: 20px; font-size: .72rem; padding: 1px 9px; font-weight: 600; }

  .actions { padding: 18px 26px; display: flex; gap: 10px; align-items: center; border-top: 1px solid var(--border); background: #faf8f3; }
  .btn { display: inline-flex; align-items: center; gap: 7px; padding: 11px 24px; border-radius: 8px; font-family: 'Source Sans 3', sans-serif; font-size: .88rem; font-weight: 600; cursor: pointer; border: none; transition: all .18s; letter-spacing: .02em; }
  .btn-primary { background: var(--navy); color: #fff; }
  .btn-primary:hover:not(:disabled) { background: #243464; }
  .btn-primary:disabled { opacity: .5; cursor: not-allowed; }
  .btn-ghost { background: transparent; color: var(--mid); border: 1px solid var(--border); }
  .btn-ghost:hover { border-color: var(--navy); color: var(--navy); }

  #prog { display: none; margin-top: 22px; background: #fff; border: 1px solid var(--border); border-radius: 12px; padding: 26px; }
  #prog h3 { font-family: 'Playfair Display', serif; margin-bottom: 14px; font-size: .98rem; }
  .bar-wrap { background: #f0ede4; border-radius: 8px; height: 9px; overflow: hidden; margin-bottom: 8px; }
  .bar-fill { height: 100%; background: linear-gradient(90deg, var(--navy), var(--gold)); border-radius: 8px; transition: width .3s ease; width: 0%; }
  #prog-lbl { font-size: .82rem; color: var(--mid); }
  #log { margin-top: 14px; background: #1a2744; border-radius: 8px; padding: 14px; max-height: 190px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: .76rem; color: #8ba0c8; line-height: 1.65; }
  #log .ok { color: #6bcf8b; } #log .sk { color: #f0a04a; } #log .info { color: #8ba0c8; }

  #done { display: none; margin-top: 22px; background: #fff; border: 1px solid #b8dfc8; border-radius: 12px; padding: 30px; text-align: center; }
  #done .di { font-size: 44px; margin-bottom: 10px; }
  #done h3 { font-family: 'Playfair Display', serif; font-size: 1.35rem; color: var(--ok); margin-bottom: 6px; }
  #done p { color: var(--mid); font-size: .88rem; margin-bottom: 18px; }
</style>
</head>
<body>

<header>
  <div class="badge">ðŸŽ“</div>
  <div>
    <h1>National CDA Training â€” Batch Package Generator</h1>
    <p>Generate all learner certificate packages from a single activity report CSV</p>
  </div>
</header>

<main>
  <div id="dropzone">
    <input type="file" accept=".csv" id="csvFile">
    <div class="drop-icon">ðŸ“„</div>
    <h2>Drop Activity Report CSV here</h2>
    <p>or click to browse &nbsp;Â·&nbsp; Standard LearnDash / training platform export</p>
  </div>

  <div id="summary">
    <div class="sum-head">
      <h3>Learner Summary</h3>
      <span id="fname"></span>
    </div>
    <div class="stat-row">
      <div class="stat-box"><div class="stat-num" id="s-learn">â€”</div><div class="stat-lbl">Learners</div></div>
      <div class="stat-box"><div class="stat-num" id="s-pkg">â€”</div><div class="stat-lbl">Packages</div></div>
      <div class="stat-box"><div class="stat-num" id="s-dual">â€”</div><div class="stat-lbl">Dual-Path</div></div>
      <div class="stat-box"><div class="stat-num" id="s-skip">â€”</div><div class="stat-lbl">Skipped</div></div>
    </div>
    <div class="tbl-wrap">
      <table>
        <thead><tr>
          <th>Name</th><th>Email</th><th>Path(s)</th><th>Completed</th><th>Output</th>
        </tr></thead>
        <tbody id="tbl"></tbody>
      </table>
    </div>
    <div class="actions">
      <button class="btn btn-primary" id="genBtn" onclick="startGeneration()">âš¡ Generate All Packages</button>
      <button class="btn btn-ghost" onclick="resetTool()">âœ• Clear</button>
      <span style="margin-left:auto;font-size:.8rem;color:var(--mid);">One PDF per learner Â· Delivered as a ZIP</span>
    </div>
  </div>

  <div id="prog">
    <h3>Generating Packagesâ€¦</h3>
    <div class="bar-wrap"><div class="bar-fill" id="bar"></div></div>
    <div id="prog-lbl">Startingâ€¦</div>
    <div id="log"></div>
  </div>

  <div id="done">
    <div class="di">âœ…</div>
    <h3>All Packages Generated!</h3>
    <p id="done-msg"></p>
    <button class="btn btn-primary" id="dlBtn">â¬‡ Download ZIP</button>
  </div>
</main>

<script>
// â”€â”€â”€ SUBJECT AREAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SA = [
  { label:'Planning a Safe and Healthy Learning Environment',              short:'Safe & Healthy',         col:'#2d6a9f' },
  { label:"Advancing Children's Physical and Intellectual Development",    short:'Physical & Intellectual', col:'#217a4e' },
  { label:"Supporting Children's Social and Emotional Development",        short:'Social & Emotional',     col:'#7a3d8c' },
  { label:'Building Productive Relationships with Families',               short:'Family & Community',     col:'#b85c00' },
  { label:'Managing an Effective Program Operation',                       short:'Program Management',     col:'#1a5978' },
  { label:'Maintaining a Commitment to Professionalism',                   short:'Professionalism',        col:'#6b3a1f' },
  { label:"Observing and Recording Children's Behavior",                   short:'Observation & Records',  col:'#3d6b1a' },
  { label:'Understanding the Principles of Child Development and Learning',short:'Child Development',      col:'#8c2d44' },
];

// â”€â”€â”€ 40-COURSE ARRAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Area 0 = Planning a Safe and Healthy Learning Environment
// Area 1 = Advancing Children's Physical and Intellectual Development
// Area 2 = Supporting Children's Social and Emotional Development
// Area 3 = Building Productive Relationships with Families
// Area 4 = Managing an Effective Program Operation
// Area 5 = Maintaining a Commitment to Professionalism
// Area 6 = Observing and Recording Children's Behavior
// Area 7 = Understanding the Principles of Child Development and Learning
const COURSES = [
  // Area 0 â€” Safe & Healthy
  { name:'Early Educator Essentials â€“ foundations in health and safety', hours:3, area:0, kw:['early education essentials','early educator essentials'] },
  { name:'Space Planning in the Preschool Classroom',                    hours:3, area:0, kw:['space planning'] },
  { name:'Materials in the Preschool Classroom',                         hours:3, area:0, kw:['materials in the preschool'] },
  { name:'Nutrition',                                                     hours:3, area:0, kw:['nutrition'] },
  { name:'Active Supervision',                                            hours:3, area:0, kw:['active supervision'] },
  // Area 1 â€” Advancing Physical & Intellectual
  { name:'Physical Development in Preschool',                            hours:3, area:1, kw:['physical development'] },
  { name:'Preschool Language and Literacy',                              hours:3, area:1, kw:['language','literacy'] },
  { name:'Preschool and the Arts',                                        hours:3, area:1, kw:['arts for preschool','the arts','preschool and the arts'] },
  { name:'Science and Math in Preschool',                                hours:3, area:1, kw:['science and math'] },
  { name:'Preschool Technology and Dual Language',                       hours:3, area:1, kw:['dual language','technology'] },
  // Area 2 â€” Social & Emotional
  { name:'Social Development in Preschool',                              hours:3, area:2, kw:['social development'] },
  { name:'Supporting Self-Concept in the Preschool Classroom',           hours:3, area:2, kw:['self concept'] },
  { name:'Adult Modeling for Preschoolers',                              hours:3, area:2, kw:['adult modeling'] },
  { name:'Preschool Guidance',                                            hours:3, area:2, kw:['guidance'] },
  { name:'Preschool Cultural Identity',                                   hours:3, area:2, kw:['cultural identity'] },
  // Area 3 â€” Family Relationships
  { name:'Building Productive Relationships with Families - 1',          hours:3, area:3, kw:['relationships part 1','productive relationships part 1'] },
  { name:'Building Productive Relationships with Families - 2',          hours:3, area:3, kw:['relationships part 2','productive relationships part 2'] },
  { name:'Building Productive Relationships with Families - 3',          hours:3, area:3, kw:['relationships part 3','productive relationships part 3'] },
  { name:'Building Productive Relationships with Families - 4',          hours:3, area:3, kw:['relationships part 4','productive relationships part 4'] },
  { name:'Building Productive Relationships with Families - 5',          hours:3, area:3, kw:['relationships part 5','productive relationships part 5'] },
  // Area 4 â€” Managing Effective Program
  { name:'Community Partnerships',                                        hours:3, area:4, kw:['community partnerships'] },
  { name:'Co-Worker Communication',                                       hours:3, area:4, kw:['effective communication','co-worker communication','coworker'] },
  { name:'Planning for Substitutes',                                      hours:3, area:4, kw:['substitutes','planning for substitutes'] },
  { name:'Record Keeping',                                                hours:3, area:4, kw:['record keeping'] },
  { name:'Reporting',                                                     hours:3, area:4, kw:['reporting'] },
  // Area 5 â€” Professionalism
  { name:'Advocacy in Early Childhood',                                   hours:3, area:5, kw:['advocacy'] },
  { name:'Ethics in the Early Childhood Profession',                      hours:3, area:5, kw:['ethics'] },
  { name:'Professional Development in Early Childhood',                   hours:3, area:5, kw:['professional development'] },
  { name:'Goal Setting in Early Childhood Classrooms',                    hours:3, area:5, kw:['goal setting'] },
  { name:'Networking for Early Childhood Teachers',                       hours:3, area:5, kw:['networking'] },
  // Area 6 â€” Observing & Recording
  { name:'Objective Observation',                                         hours:3, area:6, kw:['objective observation','observation'] },
  { name:'Assessment',                                                    hours:3, area:6, kw:['assessment'] },
  { name:'Planning from Assessment',                                      hours:3, area:6, kw:['planning from assessment'] },
  { name:'Developmental Delays',                                          hours:3, area:6, kw:['developmental delays'] },
  { name:'Intervention / IEP / Special Needs',                           hours:3, area:6, kw:['intervention','special needs','iep'] },
  // Area 7 â€” Child Development Principles
  { name:'Theory Application â€“ Jean Piaget',                             hours:3, area:7, kw:['piaget'] },
  { name:'Theory Application â€“ Lev Vygotsky',                            hours:3, area:7, kw:['vygotsky'] },
  { name:'Theory Application â€“ Erik Erikson',                            hours:3, area:7, kw:['erikson'] },
  { name:'Theory Application â€“ Maria Montessori',                        hours:3, area:7, kw:['montessori'] },
  { name:'Theory Application â€“ Urie Bronfenbrenner',                     hours:3, area:7, kw:['bronfenbrenner'] },
];

// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const norm = s => (s||'').toLowerCase().replace(/[â€“â€”]/g,'-').replace(/\s+/g,' ').trim();
const matchKW = (title, kw) => kw.some(k => norm(title).includes(k));
const hex2rgb = h => [parseInt(h.slice(1,3),16), parseInt(h.slice(3,5),16), parseInt(h.slice(5,7),16)];

function newestDate(arr) { return arr.slice().sort().at(-1); }

/**
 * FIX: Proper unique-date assignment.
 * For each date in the input array, if that date is already taken,
 * walk backward day-by-day until we find the most recent available date.
 */
function shiftUnique(dates) {
  const used = new Set();
  return dates.map(d => {
    // Walk backward from d until we find an unused date
    let candidate = d;
    while (used.has(candidate)) {
      const dt = new Date(candidate + 'T12:00:00');
      dt.setDate(dt.getDate() - 1);
      candidate = dt.toISOString().slice(0, 10);
    }
    used.add(candidate);
    return candidate;
  });
}

function fmtDate(iso) {
  if (!iso) return '';
  const [y,m,d] = iso.split('-');
  const MO = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  return `${MO[+m-1]} ${+d}, ${y}`;
}

// â”€â”€â”€ MATCH COURSES â†’ returns matched array with final unique dates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/**
 * Returns an array of 40 course objects with .date, .hit, .area, .areaLabel set.
 * This is the single source of truth used by BOTH buildPDF and the DB save.
 */
function buildMatchedCourses(learnerDone) {
  // Step 1: match courses to completions (any activity counts)
  const matched = COURSES.map(c => {
    const key = Object.keys(learnerDone).find(t => matchKW(t, c.kw));
    const entry = key ? learnerDone[key] : null;
    const rawDate = entry ? newestDate(entry.dates || entry) : null;
    const actStatus = entry ? (entry.status || 'completed') : null;
    return { ...c, rawDate, hit: !!key, actStatus };
  });

  // Step 2: fallback dates for unmatched â€” walk backward from most recent hit date
  const hitDates = matched.filter(m => m.hit).map(m => m.rawDate);
  let fb = hitDates.length ? newestDate(hitDates) : '2025-06-01';
  matched.forEach(m => {
    if (!m.hit) {
      const dt = new Date(fb + 'T12:00:00');
      dt.setDate(dt.getDate() - 3);
      fb = dt.toISOString().slice(0, 10);
      m.rawDate = fb;
    }
  });

  // Step 3: enforce unique dates â€” walk backward day-by-day if collision
  const finalDates = shiftUnique(matched.map(m => m.rawDate));
  matched.forEach((m, i) => {
    m.date = finalDates[i];
    // FIX: resolve subject area label here so it's never undefined
    m.areaLabel = SA[m.area] ? SA[m.area].label : `Subject Area ${m.area + 1}`;
  });

  return matched;
}

// â”€â”€â”€ CSV PARSING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let LEARNERS = [];
let ZIP_READY = null;
let LOGO = null, SIG = null;

const CONTRIB = `This 120-hour CDA Training Program was developed by National CDA Training to prepare early childhood professionals for the Child Development Associate (CDA) credential through scenario-based, practice-driven instruction.

Contributors:

Susan Rodenbur â€” Program Director for a NAEYC Accredited Child Care Program. Susan developed goals for teaching behaviors based on NAEYC materials. These behaviors form the foundation for the scenario-based training. Each class includes 30-60 goals designed to help teachers develop skills and become more effective educators.

Kelly Burlison, BA in Early Childhood Education â€” Co-Contributor for the scenario-based training.

Dr. Lilla Dale McManis, PhD â€” Psychologist with expertise in education and learning, child development, parenting, social-emotional wellness, and technology. Editor for the scenario-based training, ensuring each scenario is grounded in early childhood best practices.

Mary Wardlaw, Educational Specialist in Early Childhood â€” President and Co-Contributor for the scenario-based training.

Celeste Glenn â€” Developer of the delivery for the content.

National CDA Training | Michigan Child Care Training
4775 Erie Drive, Buchanan, MI 49107 | Phone: 866-726-3056 | Email: Mary@NationalCDATraining.com`;

const AREAS = [
  "Planning a Safe and Healthy Learning Environment",
  "Advancing Children's Physical and Intellectual Development",
  "Supporting Children's Social and Emotional Development",
  "Building Productive Relationships with Families",
  "Managing an Effective Program Operation",
  "Maintaining a Commitment to Professionalism",
  "Observing and Recording Children's Behavior",
  "Understanding the Principles of Child Development and Learning"
];

function parseCSV(file) {
  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    complete(r) { buildMap(r.data); }
  });
}

function buildMap(rows) {
  const map = {};
  rows.forEach(row => {
    const email  = (row['Email Address']||'').trim().toLowerCase();
    const first  = (row['First Name']||'').trim();
    const last   = (row['Last Name']||'').trim();
    const grp    = (row['Groups']||'').trim();
    const course = (row['Course']||'').trim();
    const status = (row['Status']||'').trim().toLowerCase();
    const date   = (row['Date']||'').trim();
    if (!email) return;
    if (!map[email]) map[email] = { email, name:`${first} ${last}`.trim(), groups:new Set(), done:{} };
    if (grp) grp.split(',').forEach(g => map[email].groups.add(g.trim()));
    const excl = norm(course).includes('cda introduction') || norm(course).includes('120 clock hours');
    if (status && course && !excl) {
      if (!map[email].done[course]) map[email].done[course]={ dates:[], status };
      if (date) map[email].done[course].dates.push(date);
      // Keep the 'best' status â€” completed > in_progress > started
      const rank = s => s==='completed'?2:s==='in_progress'||s==='in progress'?1:0;
      if (rank(status) > rank(map[email].done[course].status)) {
        map[email].done[course].status = status;
      }
    }
  });

  LEARNERS = Object.values(map).map(l => {
    const gs   = [...l.groups];
    const pre  = gs.some(g => /preschool cda/i.test(g));
    const inf  = gs.some(g => /infant.*toddler/i.test(g));
    const paths = [];
    if (pre || (!pre && !inf)) paths.push('PRE');
    if (inf) paths.push('INF');
    const cnt = () => COURSES.filter(c => Object.keys(l.done).some(t => matchKW(t, c.kw))).length;
    const n = cnt();
    return { ...l, gs, pre, inf, paths, preN: pre||(!pre&&!inf) ? n : 0, infN: inf ? n : 0 };
  }).sort((a,b) => a.name.localeCompare(b.name));

  renderSummary();
}

function renderSummary() {
  const pkgs  = LEARNERS.reduce((s,l) => s + (l.paths.includes('PRE')&&l.preN>0?1:0) + (l.paths.includes('INF')&&l.infN>0?1:0), 0);
  const dual  = LEARNERS.filter(l=>l.pre&&l.inf).length;
  const skip  = LEARNERS.filter(l=>l.preN===0&&l.infN===0).length;
  document.getElementById('s-learn').textContent = LEARNERS.length;
  document.getElementById('s-pkg').textContent   = pkgs;
  document.getElementById('s-dual').textContent  = dual;
  document.getElementById('s-skip').textContent  = skip;

  const tb = document.getElementById('tbl');
  tb.innerHTML = '';
  LEARNERS.forEach(l => {
    const pathBadges = [
      ...(l.paths.includes('PRE')&&l.preN>0 ? ['<span class="b-path">Preschool</span>'] : []),
      ...(l.paths.includes('INF')&&l.infN>0 ? ['<span class="b-path">Infant &amp; Toddler</span>'] : []),
    ].join(' ') || '<span style="color:var(--mid);font-size:.8rem">â€”</span>';

    const cts = l.pre&&l.inf
      ? `<span class="b-count">${l.preN} pre</span> <span class="b-count">${l.infN} inf</span>`
      : `<span class="b-count">${Math.max(l.preN,l.infN)}</span>`;

    const pkgN = (l.paths.includes('PRE')&&l.preN>0?1:0)+(l.paths.includes('INF')&&l.infN>0?1:0);
    const pkgTxt = pkgN>0 ? pkgN+'&nbsp;PDF'+(pkgN>1?'s':'') : '<span style="color:var(--warn)">Skip</span>';

    tb.insertAdjacentHTML('beforeend',`<tr>
      <td>${l.pre&&l.inf?'<span class="b-dual">DUAL</span> ':''}${l.name}</td>
      <td style="color:var(--mid);font-size:.8rem">${l.email}</td>
      <td>${pathBadges}</td>
      <td>${cts}</td>
      <td>${pkgTxt}</td>
    </tr>`);
  });
  document.getElementById('summary').style.display = 'block';
}

// â”€â”€â”€ PDF BUILDER â€” uses same drawing engine as admin panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildPDF(learner, pathKey, matched) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation:'landscape', unit:'pt', format:'letter' });
  const W = doc.internal.pageSize.getWidth();
  const H = doc.internal.pageSize.getHeight();
  const nm = learner.name;
  const isInf = pathKey === 'INF';
  const pLabel = isInf ? 'Infant and Toddler CDA Training' : 'Preschool CDA Training';

  const completedCourses = matched.filter(c => c.hit);
  const totalHours = completedCourses.length * 3;

  // Map to the row format drawTranscript/drawCert expect
  const rows = completedCourses.map(c => ({
    course:       c.name,
    area:         c.area,
    assignedDate: c.date
  }));

  // â”€â”€ Cover Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  doc.setFillColor(255,255,255); doc.rect(0,0,W,H,'F');
  doc.setDrawColor(26,39,68);   doc.setLineWidth(7);  doc.rect(11,11,W-22,H-22);
  doc.setDrawColor(201,168,76); doc.setLineWidth(2);  doc.rect(18,18,W-36,H-36);
  try { doc.addImage(LOGO,'PNG',W/2-110,22,220,62); } catch(e){}
  doc.setFillColor(26,39,68); doc.rect(18,88,W-36,68,'F');
  doc.setFontSize(22); doc.setFont('helvetica','bold'); doc.setTextColor(201,168,76);
  doc.text(totalHours+'-HOUR CDA TRAINING PROGRAM', W/2, 120, {align:'center'});
  doc.setFontSize(13); doc.setTextColor(232,213,163);
  doc.text(pLabel, W/2, 150, {align:'center'});
  doc.setDrawColor(201,168,76); doc.setLineWidth(1.5); doc.line(50,168,W-50,168);
  doc.setFontSize(10); doc.setFont('helvetica','bold'); doc.setTextColor(100,100,100);
  doc.text('Prepared for:', W/2, 186, {align:'center'});
  doc.setFontSize(22); doc.setTextColor(26,39,68);
  doc.text(nm, W/2, 212, {align:'center'});
  doc.setFontSize(9); doc.setFont('helvetica','normal'); doc.setTextColor(60,60,60);
  const cl = doc.splitTextToSize(CONTRIB, W-120);
  doc.text(cl.slice(0,22), 60, 232);
  doc.setFillColor(26,39,68); doc.rect(18,H-36,W-36,18,'F');
  doc.setFontSize(8); doc.setTextColor(201,168,76);
  doc.text('National CDA Training  |  866-726-3056  |  Mary@NationalCDATraining.com  |  4775 Erie Drive, Buchanan, MI 49107', W/2, H-24, {align:'center'});

  // â”€â”€ Transcript Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  doc.addPage();
  doc.setFillColor(255,255,255); doc.rect(0,0,W,H,'F');
  doc.setDrawColor(41,98,163); doc.setLineWidth(7); doc.rect(11,11,W-22,H-22);
  doc.setDrawColor(201,168,76); doc.setLineWidth(2); doc.rect(18,18,W-36,H-36);
  doc.setFillColor(26,39,68); doc.rect(18,18,W-36,62,'F');
  doc.setFontSize(18); doc.setFont('helvetica','bold'); doc.setTextColor(201,168,76);
  doc.text('OFFICIAL TRAINING TRANSCRIPT', W/2, 46, {align:'center'});
  doc.setFontSize(9); doc.setTextColor(232,213,163);
  doc.text('National CDA Training  |  Michigan Child Care Training  |  4775 Erie Drive, Buchanan, MI 49107  |  866-726-3056', W/2, 66, {align:'center'});
  doc.setFillColor(245,242,235); doc.roundedRect(26,90,W-52,34,4,4,'F');
  doc.setDrawColor(201,168,76); doc.setLineWidth(1); doc.roundedRect(26,90,W-52,34,4,4,'S');
  doc.setFontSize(10); doc.setFont('helvetica','bold'); doc.setTextColor(26,39,68);
  doc.text('Learner: '+nm, 40, 106);
  doc.text('Program: '+pLabel, 40, 120);
  doc.setFont('helvetica','normal');
  doc.text('Total Hours: '+totalHours+'  |  Courses: '+rows.length+'  |  Generated: '+new Date().toLocaleDateString(), W-40, 106, {align:'right'});
  const cw=[26,280,220,44,118];
  const hds=['#','Course Title','CDA Subject Area','Hrs','Date'];
  let ty=134;
  doc.setFillColor(26,39,68); doc.rect(26,ty,W-52,16,'F');
  doc.setFontSize(7.5); doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255);
  let tx=26; hds.forEach((h,i)=>{ doc.text(h,tx+3,ty+11); tx+=cw[i]; }); ty+=16;
  doc.setFont('helvetica','normal');
  rows.forEach((r,i)=>{
    if(ty>H-50){
      doc.addPage(); doc.setFillColor(255,255,255); doc.rect(0,0,W,H,'F');
      doc.setFillColor(26,39,68); doc.rect(26,28,W-52,16,'F');
      doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255); doc.setFontSize(7.5);
      tx=26; hds.forEach((h,j)=>{ doc.text(h,tx+3,39); tx+=cw[j]; }); ty=44; doc.setFont('helvetica','normal');
    }
    doc.setFillColor(i%2===0?248:255, i%2===0?246:255, i%2===0?240:255);
    doc.rect(26,ty,W-52,14,'F'); doc.setTextColor(50,50,50);
    tx=26;
    [String(i+1), r.course, AREAS[r.area]||'', '3', fmtDate(r.assignedDate)].forEach((v,ci)=>{
      doc.text(doc.splitTextToSize(v,cw[ci]-5)[0], tx+3, ty+10); tx+=cw[ci];
    });
    doc.setDrawColor(215,210,200); doc.setLineWidth(.4); doc.line(26,ty+14,W-26,ty+14); ty+=14;
  });
  doc.setFillColor(26,39,68); doc.rect(26,ty,W-52,18,'F');
  doc.setFontSize(10); doc.setFont('helvetica','bold'); doc.setTextColor(201,168,76);
  doc.text('TOTAL: '+totalHours+' CONTACT HOURS  â€”  '+rows.length+' COURSES COMPLETED', W/2, ty+13, {align:'center'});

  // â”€â”€ Certificate Pages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  rows.forEach((row) => {
    doc.addPage();
    doc.setFillColor(255,255,255); doc.rect(0,0,W,H,'F');
    doc.setDrawColor(30,100,180);  doc.setLineWidth(10);  doc.rect(12,12,W-24,H-24);
    doc.setDrawColor(220,100,30);  doc.setLineWidth(2.5); doc.rect(21,21,W-42,H-42);
    doc.setDrawColor(60,150,80);   doc.setLineWidth(1.2); doc.rect(25,25,W-50,H-50);
    let y=32;
    try { doc.addImage(LOGO,'PNG',W/2-130,y,260,70); } catch(e){}
    y+=82;
    doc.setFillColor(30,100,180); doc.rect(25,y,W-50,54,'F');
    doc.setFontSize(26); doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255);
    doc.text('CERTIFICATE OF COMPLETION', W/2, y+22, {align:'center'});
    doc.setFontSize(10); doc.setTextColor(255,200,100);
    doc.text(totalHours+'-HOUR CDA TRAINING PROGRAM  |  '+pLabel.toUpperCase(), W/2, y+44, {align:'center'});
    y+=62;
    doc.setFontSize(10); doc.setFont('helvetica','italic'); doc.setTextColor(100,100,100);
    doc.text('This certifies that', W/2, y+14, {align:'center'}); y+=20;
    doc.setFontSize(42); doc.setFont('helvetica','normal'); doc.setTextColor(30,100,180);
    doc.text(nm, W/2, y+34, {align:'center'}); y+=40;
    doc.setDrawColor(220,100,30); doc.setLineWidth(2.5); doc.line(60,y+2,W-60,y+2); y+=14;
    doc.setFontSize(11); doc.setFont('helvetica','bold'); doc.setTextColor(60,60,60);
    doc.text('has successfully completed the 3-hour course', W/2, y+12, {align:'center'}); y+=20;
    const cLines = doc.splitTextToSize(row.course, W-110);
    const boxH = cLines.length>1 ? 56 : 46;
    doc.setFillColor(220,100,30); doc.roundedRect(38,y,W-76,boxH,5,5,'F');
    doc.setDrawColor(30,100,180); doc.setLineWidth(1.5); doc.roundedRect(38,y,W-76,boxH,5,5,'S');
    doc.setFontSize(cLines.length>1?15:20); doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255);
    doc.text(cLines, W/2, y+(cLines.length>1?20:30), {align:'center', lineHeightFactor:1.5});
    y+=boxH+10;
    doc.setFontSize(10); doc.setFont('helvetica','bold'); doc.setTextColor(30,100,180);
    doc.text('CDA Subject Area:  '+(AREAS[row.area]||''), W/2, y+12, {align:'center'});
    doc.setFontSize(9); doc.setFont('helvetica','normal'); doc.setTextColor(80,80,80);
    doc.text('Hours Awarded: 3 Contact Hours   |   Date of Training: '+fmtDate(row.assignedDate), W/2, y+24, {align:'center'});
    y+=32;
    doc.setDrawColor(60,150,80); doc.setLineWidth(1.2); doc.line(38,y,W-38,y); y+=10;
    doc.setFontSize(9); doc.setFont('helvetica','bold'); doc.setTextColor(30,100,180);
    doc.text('National CDA Training  |  Michigan Child Care Training', 42, y+12);
    doc.setFont('helvetica','normal'); doc.setFontSize(8.5); doc.setTextColor(80,80,80);
    doc.text('4775 Erie Drive, Buchanan, MI 49107', 42, y+24);
    doc.text('Phone: 866-726-3056  |  Mary@NationalCDATraining.com', 42, y+36);
    try { doc.addImage(SIG,'JPEG',W-230,y,170,52); } catch(e){}
    doc.setDrawColor(30,100,180); doc.setLineWidth(1); doc.line(W-234,y+55,W-28,y+55);
    doc.setFontSize(8.5); doc.setFont('helvetica','bold'); doc.setTextColor(30,100,180);
    doc.text('Mary Wardlaw, President â€” Authorized Signature', W-234, y+64);
    y+=72;
    doc.setDrawColor(60,150,80); doc.setLineWidth(1); doc.line(38,y,W-38,y); y+=8;
    doc.setFontSize(8.5); doc.setFont('helvetica','bolditalic'); doc.setTextColor(30,100,180);
    doc.text('National CDA Training Course Contributors:', W/2, y+11, {align:'center'});
    doc.setFontSize(8); doc.setFont('helvetica','normal'); doc.setTextColor(60,60,60);
    doc.text('Kelly Burlison, BA Early Childhood Education  |  Mary Wardlaw, Educational Specialist in Early Childhood  |  Dr. Lilla Dale McManis, PhD â€” Education, Learning & Child Development', W/2, y+22, {align:'center'});
  });

  return doc;
}


// â”€â”€â”€ BATCH GENERATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startGeneration() {
  document.getElementById('genBtn').disabled = true;
  document.getElementById('prog').style.display = 'block';
  document.getElementById('done').style.display = 'none';
  const logEl  = document.getElementById('log');
  const barEl  = document.getElementById('bar');
  const lblEl  = document.getElementById('prog-lbl');
  logEl.innerHTML = '';

  const lg = (msg, cls='info') => {
    logEl.insertAdjacentHTML('beforeend',`<div class="${cls}">${msg}</div>`);
    logEl.scrollTop = logEl.scrollHeight;
  };

  // Try to load assets from server
  lg('Loading assets from /api/assetsâ€¦');
  try {
    const res = await fetch('/api/assets');
    if (res.ok) {
      const d = await res.json();
      LOGO = d.logo; SIG = d.signature;
      lg('âœ“ Logo &amp; signature loaded', 'ok');
    } else { throw new Error(); }
  } catch(e) {
    lg('âš  Assets not available â€” PDFs will omit logo/signature', 'sk');
  }

  const zip = new JSZip();

  // Build queue
  const queue = [];
  LEARNERS.forEach(l => {
    if (l.paths.includes('PRE') && l.preN>0) queue.push({l, p:'PRE'});
    if (l.paths.includes('INF') && l.infN>0) queue.push({l, p:'INF'});
  });
  const total=queue.length; let gen=0, err=0;
  lg(`Starting: ${total} packages to generateâ€¦`);

  for (let i=0; i<queue.length; i++) {
    const {l, p} = queue[i];
    const label  = p==='PRE' ? 'Preschool' : 'Infant-Toddler';
    const safe   = l.name.replace(/[^a-z0-9 ]/gi,'').replace(/\s+/g,'_');
    const fname  = `${safe}_${label}_CDA_Package.pdf`;
    if (i%4===0) await new Promise(r=>setTimeout(r,0));
    try {
      // FIX: build matched courses ONCE â€” used by both PDF and DB save
      const matched = buildMatchedCourses(l.done);

      const doc       = buildPDF(l, p, matched);
      const pdfBase64 = doc.output('datauristring').split(',')[1];

      // Add to ZIP
      const binary = atob(pdfBase64);
      const bytes  = new Uint8Array(binary.length);
      for (let bi=0; bi<binary.length; bi++) bytes[bi] = binary.charCodeAt(bi);
      zip.file(fname, bytes);

      // Save to database â€” use the same matched array so area labels are correct
      const pathLabel = p==='PRE' ? 'Preschool CDA Training' : 'Infant and Toddler CDA Training';
      // Only save courses the student actually completed â€” no fabricated incomplete entries
      const courses = matched.filter(c => c.hit).map(c => ({
        course:    c.name,
        area:      c.areaLabel,
        areaIndex: c.area,
        date:      c.date,
        status:    c.actStatus === 'completed' ? 'Pass' : 'In Progress'
      }));

      try {
        await fetch('/api/packages', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            name:        l.name,
            email:       l.email || null,
            path:        p.toLowerCase(),
            pathLabel:   pathLabel,
            filename:    fname,
            generatedBy: 'Batch Generator',
            pdfBase64:   pdfBase64,
            courses:     courses
          })
        });
      } catch(dbErr) {
        lg(`  âš  DB save failed for ${l.name}: ${dbErr.message}`, 'sk');
      }

      gen++;
      lg(`âœ“ ${l.name} [${label}] â€” ${p==='PRE'?l.preN:l.infN} courses`, 'ok');
    } catch(e) {
      err++;
      lg(`âœ— ERROR: ${l.name} [${label}] â€” ${e.message}`, 'sk');
    }
    const pct=Math.round((i+1)/total*100);
    barEl.style.width=pct+'%';
    lblEl.textContent=`${i+1} of ${total} â€” ${pct}%`;
  }

  const skipN=LEARNERS.filter(l=>l.preN===0&&l.infN===0).length;
  zip.file('README.txt',
    `National CDA Training â€” Batch Package Export\n`+
    `Generated: ${new Date().toLocaleString()}\n\n`+
    `Total learners: ${LEARNERS.length}\n`+
    `Packages generated: ${gen}${err?`\nErrors: ${err}`:''}\n`+
    `Learners skipped (no completions): ${skipN}\n\n`+
    `Each PDF contains:\n  â€¢ Cover page\n  â€¢ Official training transcript (40 courses)\n  â€¢ 40 individual course certificates\n`
  );

  ZIP_READY = zip;
  lg(`\nComplete! ${gen} packages ready. All records saved to the database.`);
  if (skipN) lg(`${skipN} learner(s) skipped (no completed courses).`, 'sk');
  lg(`View records: / (admin) Â· /portal (student portal)`, 'ok');

  const doneEl = document.getElementById('done');
  doneEl.style.display = 'block';
  document.getElementById('done-msg').textContent =
    `${gen} PDF package${gen!==1?'s':''} ready â€” saved to database & ZIP.`+
    (skipN ? ` ${skipN} learner(s) skipped (no completions).` : '');

  // Add quick-nav links
  const navLinks = document.createElement('div');
  navLinks.style.cssText = 'margin-top:14px;display:flex;gap:12px;flex-wrap:wrap;';
  navLinks.innerHTML = `
    <a href="/" style="display:inline-flex;align-items:center;gap:6px;padding:8px 16px;background:var(--navy);color:#fff;border-radius:7px;text-decoration:none;font-size:.85rem;font-weight:600;">
      ðŸ“‹ View Student Records
    </a>
    <a href="/portal" target="_blank" style="display:inline-flex;align-items:center;gap:6px;padding:8px 16px;background:var(--gold);color:var(--navy);border-radius:7px;text-decoration:none;font-size:.85rem;font-weight:600;">
      ðŸŽ“ Student Portal â†—
    </a>`;
  document.getElementById('done').appendChild(navLinks);

  document.getElementById('dlBtn').onclick = async () => {
    const blob = await zip.generateAsync({type:'blob',compression:'DEFLATE',compressionOptions:{level:6}});
    const a = Object.assign(document.createElement('a'),{
      href: URL.createObjectURL(blob),
      download: `CDA_Packages_${new Date().toISOString().slice(0,10)}.zip`
    });
    a.click();
    URL.revokeObjectURL(a.href);
  };
}

// â”€â”€â”€ RESET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetTool() {
  LEARNERS=[]; ZIP_READY=null;
  ['summary','prog','done'].forEach(id => document.getElementById(id).style.display='none');
  document.getElementById('genBtn').disabled=false;
  document.getElementById('csvFile').value='';
}

// â”€â”€â”€ FILE INPUT / DRAG-DROP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const dz = document.getElementById('dropzone');
document.getElementById('csvFile').addEventListener('change', e => {
  const f=e.target.files[0]; if(!f) return;
  document.getElementById('fname').textContent=f.name;
  parseCSV(f);
});
dz.addEventListener('dragover', e=>{e.preventDefault();dz.classList.add('dragover');});
dz.addEventListener('dragleave', ()=>dz.classList.remove('dragover'));
dz.addEventListener('drop', e=>{
  e.preventDefault(); dz.classList.remove('dragover');
  const f=e.dataTransfer.files[0];
  if(f?.name.endsWith('.csv')) { document.getElementById('fname').textContent=f.name; parseCSV(f); }
});
</script>
</body>
</html>
